<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®å® Diet Pro</title>
    <style>
        :root {
            --bg: #F8F8F7;
            --card: #FFFFFF;
            --section-bg: #F1F1EF; 
            --text: #444442;
            --sub: #A5A5A2;
            --accent: #92A38E; 
            --warn: #C68E86;   <!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®å® Diet Pro</title>
    <style>
        :root {
            --bg: #F8F8F7;
            --card: #FFFFFF;
            --section-bg: #F1F1EF; 
            --text: #444442;
            --sub: #A5A5A2;
            --accent: #92A38E; 
            --warn: #C68E86;   
            --border: #F0F0EE;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; padding-bottom: 20px;
            -webkit-font-smoothing: antialiased;
        }

        #splash {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; transition: opacity 0.5s;
        }
        .typing-container { font-size: 20px; font-weight: 600; min-height: 1.5em; margin-bottom: 10px; }
        .welcome-emoji { font-size: 32px; margin-bottom: 35px; }

        .app-container { width: 90%; max-width: 400px; margin: 0 auto; padding-top: 15px; }

        .mode-nav { display: flex; background: var(--section-bg); border-radius: 14px; padding: 4px; margin-bottom: 12px; }
        .mode-btn { flex: 1; border: none; padding: 10px; border-radius: 10px; font-size: 13px; background: transparent; cursor: pointer; color: var(--sub); transition: 0.3s; }
        .mode-btn.active { background: var(--card); color: var(--text); font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }

        .card { background: var(--card); border-radius: 28px; padding: 10px 22px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .row { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .row:last-child { border-bottom: none; }
        .item-info { flex: 1; display: flex; align-items: center; }
        .item-emoji { font-size: 26px; margin-right: 14px; }
        .item-text { display: flex; flex-direction: column; }
        .tag { font-size: 10px; color: var(--sub); margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
        .name { font-size: 15px; font-weight: 600; color: #333; }
        .kcal-box { font-size: 14px; margin-right: 14px; font-weight: 700; width: 75px; text-align: right; color: var(--text); }
        
        .refresh-btn { 
            background: linear-gradient(135deg, #FDFDFB 0%, #F4F4F2 100%); 
            border: 1px solid #EDEDEB; width: 38px; height: 38px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
        }

        .summary { margin-top: 12px; background: var(--section-bg); border-radius: 24px; padding: 16px; position: relative; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; text-align: center; }
        .grid-item { position: relative; cursor: pointer; padding: 6px; border-radius: 10px; transition: 0.2s; }
        .grid-item:active { background: #E5E5E3; }
        .v { font-size: 15px; font-weight: 800; display: block; }
        .l { font-size: 9px; color: var(--sub); font-weight: 500; }
        
        .popover { 
            position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
            background: #444; color: #FFF; padding: 5px 10px; border-radius: 8px;
            font-size: 11px; white-space: nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none; z-index: 10;
        }

        .advice { font-size: 12px; border-top: 1px solid #DCDCD7; padding-top: 12px; color: #555; line-height: 1.6; }
        .main-roll { 
            width: 100%; border: none; padding: 18px; border-radius: 22px; 
            background: linear-gradient(90deg, #444442 0%, #5A5A58 100%); 
            color: white; margin-top: 15px; font-weight: 700; font-size: 16px; cursor: pointer; 
        }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="splash">
        <div class="typing-container" id="typewriter"></div>
        <div class="welcome-emoji" id="splash-emoji">ğŸ±</div>
        <button onclick="startApp()" style="padding:16px 40px; border-radius:30px; border:none; background:var(--accent); color:white; font-size:15px; font-weight:600; cursor:pointer;">ä»Šæ—¥ã®çŒ®ç«‹ã€è¦‹ã¦ã¿ã‚ˆã£ã‹ã€‚</button>
    </div>

    <div class="app-container">
        <div class="mode-nav">
            <button class="mode-btn active" id="m-btn" onclick="toggleMode('morning')">æœé£Ÿ</button>
            <button class="mode-btn" id="l-btn" onclick="toggleMode('meal')">æ˜¼ãƒ»å¤•é£Ÿ</button>
        </div>

        <div class="card" id="list"></div>

        <div class="summary">
            <div class="grid">
                <div class="grid-item" onclick="showPop(this)"><span class="v" id="k">0</span><span class="l">kcal</span><div class="popover">ã‚¨ãƒãƒ«ã‚®ãƒ¼</div></div>
                <div class="grid-item" onclick="showPop(this)"><span class="v" id="p">0</span><span class="l">P(g)</span><div class="popover">ã‚¿ãƒ³ãƒ‘ã‚¯è³ª</div></div>
                <div class="grid-item" onclick="showPop(this)"><span class="v" id="f">0</span><span class="l">F(g)</span><div class="popover">è„‚è³ª</div></div>
                <div class="grid-item" onclick="showPop(this)"><span class="v" id="c">0</span><span class="l">C(g)</span><div class="popover">ç‚­æ°´åŒ–ç‰©</div></div>
            </div>
            <div class="advice">
                <span id="adv-base">...</span>
                <span class="emotional-container" id="adv-emo"></span>
            </div>
        </div>

        <button class="main-roll" onclick="rollAllWithSound()">åˆ¥ã®çŒ®ç«‹ã‚’è¦‹ã‚‹</button>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playCrystalSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); 
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.08, now + 0.002); 
            gain.gain.linearRampToValueAtTime(0, now + 0.04); 
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(now); osc.stop(now + 0.05);
        }

        let mode = 'morning';
        let selection = {};
        const queues = { splash:[], normal:[], excess:[], heal:[], food: { morning:{}, meal:{} } };
        const pool_splash = ["ğŸ±", "ğŸœ", "ğŸ£", "ğŸ•", "ğŸ¥©", "ğŸ›", "ğŸ", "ğŸ™", "ğŸ³", "ğŸ¥"];
        const pool_normal = ["ã¡ã‚‡ã†ã©ã„ã„æ„Ÿã˜ â˜ºï¸", "ã„ã„æ„Ÿã˜ã«é£Ÿã¹ã‚‰ã‚ŒãŸã­ ğŸƒ", "ãƒãƒ©ãƒ³ã‚¹ã„ã„ã˜ã‚ƒã‚“ ğŸŒ¿", "å¿ƒåœ°ã„ã„ä¸€é£Ÿã ã­ â˜ï¸", "ã„ã„ã¨æ€ã† ğŸ¤", "ä»Šæ—¥ã®é‡ã€ã´ã£ãŸã‚Š ğŸ¥¢"];
        const pool_excess = ["ã¡ã‚‡ã£ã¨å¤šã„ã‹ã‚‚ï¼Ÿã§ã‚‚æ°—ã«ã—ãªãã¦ã„ã„ã‚ˆ ğŸŒ¸", "å°‘ã—å¤šã‚ã ã‘ã©ã€å¤§ä¸ˆå¤«ã ã‚ˆ ğŸŠ", "ä»Šæ—¥ã¯ãƒªãƒƒãƒãªé£Ÿäº‹ã ã­ ğŸŒ¼", "æº€è¶³æ„Ÿã‚ã‚‹ã­ã€œ ğŸµ", "ãŠè…¹ã„ã£ã±ã„ã ã­ ğŸ¥"];
        const pool_heal = [" ã¾ãŸèµ·ãã‚‰ã‚Œã¾ã—ãŸã­ã€ã™ã”ã„ã€œ", " ä»Šæ—¥ã‚‚æ— äº‹ã«ç›®è¦šã‚ãŸã€œ", " ä»Šã¯ã‚†ã£ãã‚Šã§ãã‚‹æ—¶é—´ã ã­ã€œ", " ã¾ãŸæ— äº‹ã«ä¸€æ—¥è¿‡ã”ã›ãŸã­ã€‚"];

        const db = {
            morning: {
                staple: [
                    {e:"ğŸ—", n:"ãƒ•ã‚¡ãƒŸãƒã‚­", k:252, p:12.7, f:16.5, c:13.1}, {e:"ğŸ§‡", n:"ãƒ¯ãƒƒãƒ•ãƒ«", k:245, p:4.2, f:12.6, c:28.4}, {e:"ğŸ¥ª", n:"ãƒŸãƒƒã‚¯ã‚¹ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ", k:312, p:10.5, f:16.8, c:29.1}, {e:"ğŸŒ­", n:"ã‚¢ãƒ¡ãƒªã‚«ãƒ³ãƒ‰ãƒƒã‚°", k:285, p:7.2, f:14.2, c:31.5},
                    {e:"ğŸš", n:"ï¼´ï¼«ï¼§", k:310, p:9.1, f:6.2, c:53.5}, {e:"ğŸš", n:"ç´è±†ã”é£¯", k:355, p:12.8, f:6.1, c:61.2}, {e:"ğŸ™", n:"ãƒ„ãƒŠãƒãƒ¨ãŠã«ãã‚Š", k:390, p:8.4, f:14.2, c:63.5}, {e:"ğŸ", n:"ãƒ”ã‚¶ãƒˆãƒ¼ã‚¹ãƒˆ", k:295, p:10.8, f:11.5, c:36.2}
                ]
            },
            meal: {
                // ä¸»é£Ÿï¼ˆStapleï¼‰: åŠ å…¥äº† TKG å’Œ çº³è±†é¥­
                staple: [
                    {e:"ğŸš", n:"ï¼´ï¼«ï¼§", k:310, p:9.1, f:6.2, c:53.5}, {e:"ğŸš", n:"ç´è±†ã”é£¯", k:355, p:12.8, f:6.1, c:61.2}, {e:"ğŸš", n:"æ˜å¤ªå­ã”é£¯", k:365, p:9.5, f:2.8, c:73.4}, {e:"ğŸœ", n:"æ²–ç¸„ãã°", k:520, p:20.5, f:15.2, c:72.4}, {e:"ğŸ", n:"ç„¼ããã°", k:485, p:13.2, f:18.5, c:65.4}, 
                    {e:"ğŸ›", n:"ã‹ãæšã’ã‚«ãƒ¬ãƒ¼", k:820, p:15.4, f:35.2, c:102.5}, {e:"ğŸ£", n:"å¯¿å¸ (10è²«)", k:520, p:22.4, f:3.5, c:92.4}, {e:"ğŸœ", n:"çš¿ã†ã©ã‚“", k:580, p:16.5, f:22.4, c:76.2}, {e:"ğŸ", n:"ã‚«ãƒ«ãƒœãƒŠãƒ¼ãƒ©", k:710, p:20.5, f:38.2, c:68.4}, {e:"ğŸ›", n:"ã‚ªãƒ ãƒ©ã‚¤ã‚¹", k:650, p:18.2, f:24.5, c:82.4}, {e:"ğŸ•", n:"ãƒ”ã‚¶ (3ç‰‡)", k:680, p:26.5, f:30.2, c:75.4}, {e:"ğŸ¥¢", n:"ã–ã‚‹è•éº¦", k:380, p:14.2, f:2.1, c:78.4}
                ],
                // ä¸»èœ/æ±ç‰©ï¼ˆMainï¼‰: åŒ…å«è‚‰ç±»ã€é”…ç±»ã€æ±¤ç±»
                main: [
                    {e:"ğŸ¥©", n:"ã¨ã‚“ã‹ã¤", k:420, p:20.5, f:32.4, c:11.2}, {e:"ğŸ²", n:"ã¡ã‚Šã¨ã‚Šé‹", k:380, p:28.5, f:22.4, c:9.5}, {e:"ğŸ¥©", n:"ç„¼ãè‚‰", k:440, p:18.4, f:38.2, c:5.2}, {e:"ğŸ¥˜", n:"ãƒ“ãƒ¼ãƒ•ã‚·ãƒãƒ¥ãƒ¼", k:410, p:16.5, f:28.4, c:22.5}, {e:"ğŸ¥”", n:"è‚‰ã˜ã‚ƒãŒ", k:290, p:10.2, f:12.4, c:28.5}, 
                    {e:"ğŸ³", n:"ã‚ªãƒ ãƒ¬ãƒ„", k:280, p:14.2, f:22.5, c:3.2}, {e:"ğŸ¥¬", n:"ç‰›è‚‰ã‚‚ã‚„ã—ç‚’ã‚", k:320, p:18.2, f:25.4, c:5.4}, {e:"ğŸ¥˜", n:"ã‚¯ãƒ©ãƒ ãƒãƒ£ã‚¦ãƒ€ãƒ¼", k:240, p:8.5, f:15.4, c:18.5}, {e:"ğŸ¥£", n:"è±šæ±", k:155, p:8.5, f:10.2, c:8.4}, {e:"ğŸ²", n:"æ²¹æšã’å‘³å™Œæ±", k:75, p:3.8, f:5.2, c:2.8}, {e:"ğŸµ", n:"ãŠå¸ã„ç‰©", k:12, p:0.8, f:0.1, c:1.8}, {e:"ğŸ§…", n:"ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ãƒ¼ãƒ—", k:65, p:2.1, f:3.2, c:7.5}
                ],
                // å‰¯èœ/å°é£Ÿï¼ˆSideï¼‰
                side: [
                    {e:"ğŸ¢", n:"ä¸²ã‚«ãƒ„", k:240, p:10.5, f:16.2, c:12.4}, {e:"ğŸ¥”", n:"ã‚³ãƒ­ãƒƒã‚±", k:180, p:3.8, f:10.5, c:17.5}, {e:"ğŸ¥Ÿ", n:"é¤ƒå­ (6å€‹)", k:280, p:8.5, f:15.4, c:24.5}, {e:"ğŸ¤", n:"å¤©ã·ã‚‰ç››åˆã›", k:340, p:10.2, f:22.4, c:20.5}, {e:"ğŸŸ", n:"ãƒã‚°ãƒ­ã™ãèº«", k:140, p:21.5, f:5.2, c:0.5}, 
                    {e:"â¬œ", n:"å†·ã‚„ã£ã“", k:110, p:9.2, f:5.5, c:3.5}, {e:"ğŸ³", n:"ç‰å­ç„¼ã", k:145, p:9.5, f:10.2, c:3.5}, {e:"ğŸ¢", n:"ãŠã§ã‚“", k:165, p:12.4, f:3.8, c:16.5}, {e:"ğŸŸ", n:"ãªã‚ã‚ã†", k:135, p:15.5, f:7.2, c:1.5}
                ],
                // é¥®æ–™ï¼ˆDrinkï¼‰
                drink: [
                    {e:"ğŸµ", n:"å®å®ã§ãŠèŒ¶", k:0, p:0, f:0, c:0}, {e:"ğŸ¥¤", n:"ã‚«ãƒ«ãƒ”ã‚¹", k:130, p:0.8, f:0, c:32.4}, {e:"ğŸ’§", n:"ãƒã‚«ãƒª", k:125, p:0, f:0, c:31.2}, {e:"ğŸ§ƒ", n:"é‡èœç”Ÿæ´»", k:65, p:0.8, f:0, c:15.5}, {e:"ğŸµ", n:"ã»ã†ã˜èŒ¶", k:0, p:0, f:0, c:0}, {e:"ğŸŒ¾", n:"éº¦èŒ¶", k:0, p:0, f:0, c:0}, {e:"ğŸŠ", n:"ã‚ªãƒ¬ãƒ³ã‚¸100", k:85, p:1.2, f:0, c:20.5}, {e:"ğŸ¥£", n:"ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ", k:75, p:3.8, f:2.8, c:9.5}
                ]
            }
        };

        function typeWriter(text, i, cb) {
            if (i < text.length) {
                document.getElementById("typewriter").innerHTML += text.charAt(i);
                setTimeout(() => typeWriter(text, i + 1, cb), 70);
            } else if (cb) cb();
        }

        function getUniq(queue, pool) {
            if (queue.length === 0) {
                let arr = [...pool].sort(() => Math.random() - 0.5);
                queue.push(...arr);
            }
            return queue.pop();
        }

        function getNextFood(type) {
            const list = db[mode][type];
            if (!queues.food[mode][type] || queues.food[mode][type].length === 0) {
                let arr = [...Array(list.length).keys()].sort(() => Math.random() - 0.5);
                queues.food[mode][type] = arr;
            }
            return list[queues.food[mode][type].pop()];
        }

        function showPop(el) {
            const pop = el.querySelector('.popover');
            pop.style.display = 'block';
            setTimeout(() => { pop.style.display = 'none'; }, 1500);
        }

        window.onload = () => {
            typeWriter("å®å®åƒé¥­å•¦ï¼Œè¦åƒä»€ä¹ˆå‘¢ï¼Ÿ", 0);
            document.getElementById('splash-emoji').innerText = getUniq(queues.splash, pool_splash);
        };

        function startApp() {
            playCrystalSound();
            document.getElementById('splash').style.opacity = '0';
            setTimeout(() => { document.getElementById('splash').style.display = 'none'; rollAll(); }, 500);
        }

        function toggleMode(m) {
            playCrystalSound();
            mode = m;
            document.getElementById('m-btn').classList.toggle('active', m==='morning');
            document.getElementById('l-btn').classList.toggle('active', m==='meal');
            rollAll();
        }

        function rollAllWithSound() {
            playCrystalSound();
            rollAll();
        }

        function rollAll() {
            const types = (mode === 'morning') ? ['staple'] : ['staple', 'main', 'side', 'drink'];
            types.forEach(t => selection[t] = getNextFood(t));
            updateUI();
        }

        function reRoll(t) {
            playCrystalSound();
            selection[t] = getNextFood(t);
            updateUI(t);
        }

        function updateUI(flashType = null) {
            const types = (mode === 'morning') ? ['staple'] : ['staple', 'main', 'side', 'drink'];
            const labels = {staple:'ä¸»é£Ÿ', main:'ä¸»èœ/æ±ç‰©', side:'å‰¯èœ/å°é£Ÿ', drink:'é£²ã¿ç‰©'};
            let html = "", tk=0, tp=0, tf=0, tc=0;
            
            types.forEach(t => {
                const item = selection[t];
                html += `
                <div class="row ${flashType === t ? 'fade-in' : ''}">
                    <div class="item-info">
                        <span class="item-emoji">${item.e}</span>
                        <div class="item-text">
                            <span class="tag">${labels[t]}</span>
                            <span class="name">${item.n}</span>
                        </div>
                    </div>
                    <span class="kcal-box">${Math.round(item.k)} <small>kcal</small></span>
                    <button class="refresh-btn" onclick="reRoll('${t}')">ğŸ”„</button>
                </div>`;
                tk+=item.k; tp+=item.p; tf+=item.f; tc+=item.c;
            });

            document.getElementById('list').innerHTML = html;
            document.getElementById('k').innerText = Math.round(tk);
            document.getElementById('p').innerText = tp.toFixed(1);
            document.getElementById('f').innerText = tf.toFixed(1);
            document.getElementById('c').innerText = tc.toFixed(1);

            const advBase = document.getElementById('adv-base');
            const advEmo = document.getElementById('adv-emo');
            let mainTxt = (tk > 950) ? getUniq(queues.excess, pool_excess) : getUniq(queues.normal, pool_normal);
            let healTxt = getUniq(queues.heal, pool_heal);
            advBase.innerHTML = (tk > 950) ? `<b style="color:var(--warn)">ã€åˆ†æã€‘</b> ãƒ‘ãƒ¯ãƒ•ãƒ«ï¼ ` : `<b style="color:var(--accent)">ã€åˆ†æã€‘</b> ãƒãƒ©ãƒ³ã‚¹ã„ã„ã­ï¼ `;
            advEmo.innerText = mainTxt + healTxt;
        }
    </script>
</body>
</html>
            --border: #F0F0EE;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; padding-bottom: 20px;
            -webkit-font-smoothing: antialiased;
        }

        #splash {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; transition: opacity 0.5s;
        }
        .typing-container { font-size: 20px; font-weight: 600; min-height: 1.5em; margin-bottom: 10px; }
        .welcome-emoji { font-size: 32px; margin-bottom: 35px; }

        .app-container { width: 90%; max-width: 400px; margin: 0 auto; padding-top: 15px; }

        .mode-nav { display: flex; background: var(--section-bg); border-radius: 14px; padding: 4px; margin-bottom: 12px; }
        .mode-btn { flex: 1; border: none; padding: 10px; border-radius: 10px; font-size: 13px; background: transparent; cursor: pointer; color: var(--sub); transition: 0.3s; }
        .mode-btn.active { background: var(--card); color: var(--text); font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }

        /* é¥±æ»¡å‹å¡ç‰‡ */
        .card { background: var(--card); border-radius: 28px; padding: 10px 22px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .row { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .row:last-child { border-bottom: none; }
        .item-info { flex: 1; display: flex; align-items: center; }
        .item-emoji { font-size: 26px; margin-right: 14px; }
        .item-text { display: flex; flex-direction: column; }
        .tag { font-size: 10px; color: var(--sub); margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
        .name { font-size: 15px; font-weight: 600; color: #333; }
        .kcal-box { font-size: 14px; margin-right: 14px; font-weight: 700; width: 75px; text-align: right; color: var(--text); }
        
        .refresh-btn { 
            background: linear-gradient(135deg, #FDFDFB 0%, #F4F4F2 100%); 
            border: 1px solid #EDEDEB; width: 38px; height: 38px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .refresh-btn:active { transform: scale(0.95); background: #EEE; }

        .summary { margin-top: 12px; background: var(--section-bg); border-radius: 24px; padding: 16px; position: relative; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; text-align: center; }
        .grid-item { position: relative; cursor: pointer; padding: 6px; border-radius: 10px; transition: 0.2s; }
        .grid-item:active { background: #E5E5E3; }
        .v { font-size: 15px; font-weight: 800; display: block; }
        .l { font-size: 9px; color: var(--sub); font-weight: 500; }
        
        .popover { 
            position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
            background: #444; color: #FFF; padding: 5px 10px; border-radius: 8px;
            font-size: 11px; white-space: nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none; z-index: 10;
        }

        .advice { font-size: 12px; border-top: 1px solid #DCDCD7; padding-top: 12px; color: #555; line-height: 1.6; }

        .main-roll { 
            width: 100%; border: none; padding: 18px; border-radius: 22px; 
            background: linear-gradient(90deg, #444442 0%, #5A5A58 100%); 
            color: white; margin-top: 15px; font-weight: 700; font-size: 16px; cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .main-roll:active { transform: scale(0.98); opacity: 0.9; }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="splash">
        <div class="typing-container" id="typewriter"></div>
        <div class="welcome-emoji" id="splash-emoji">ğŸ±</div>
        <button onclick="startApp()" style="padding:16px 40px; border-radius:30px; border:none; background:var(--accent); color:white; font-size:15px; font-weight:600; cursor:pointer; box-shadow: 0 4px 10px rgba(146,163,142,0.3);">ä»Šæ—¥ã®çŒ®ç«‹ã€è¦‹ã¦ã¿ã‚ˆã£ã‹ã€‚</button>
    </div>

    <div class="app-container">
        <div class="mode-nav">
            <button class="mode-btn active" id="m-btn" onclick="toggleMode('morning')">æœé£Ÿ</button>
            <button class="mode-btn" id="l-btn" onclick="toggleMode('meal')">æ˜¼ãƒ»å¤•é£Ÿ</button>
        </div>

        <div class="card" id="list"></div>

        <div class="summary">
            <div class="grid">
                <div class="grid-item" onclick="showPop(this)"><span class="v" id="k">0</span><span class="l">kcal</span><div class="popover">ã‚¨ãƒãƒ«ã‚®ãƒ¼</div></div>
                <div class="grid-item" onclick="showPop(this)"><span class="v" id="p">0</span><span class="l">P(g)</span><div class="popover">ã‚¿ãƒ³ãƒ‘ã‚¯è³ª</div></div>
                <div class="grid-item" onclick="showPop(this)"><span class="v" id="f">0</span><span class="l">F(g)</span><div class="popover">è„‚è³ª</div></div>
                <div class="grid-item" onclick="showPop(this)"><span class="v" id="c">0</span><span class="l">C(g)</span><div class="popover">ç‚­æ°´åŒ–ç‰©</div></div>
            </div>
            <div class="advice">
                <span id="adv-base">...</span>
                <span class="emotional-container" id="adv-emo"></span>
            </div>
        </div>

        <button class="main-roll" onclick="rollAllWithSound()">åˆ¥ã®çŒ®ç«‹ã‚’è¦‹ã‚‹</button>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playCrystalSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine'; 
            osc.frequency.setValueAtTime(400, now); 
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.08, now + 0.002); 
            gain.gain.linearRampToValueAtTime(0, now + 0.04); 
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + 0.05);
        }

        let mode = 'morning';
        let selection = {};
        const queues = { splash:[], normal:[], excess:[], heal:[], food: { morning:{}, meal:{} } };
        const pool_splash = ["ğŸ±", "ğŸœ", "ğŸ£", "ğŸ•", "ğŸ¥©", "ğŸ›", "ğŸ", "ğŸ™", "ğŸ³", "ğŸ¥"];
        const pool_normal = ["ã¡ã‚‡ã†ã©ã„ã„æ„Ÿã˜ â˜ºï¸", "ã„ã„æ„Ÿã˜ã«é£Ÿã¹ã‚‰ã‚ŒãŸã­ ğŸƒ", "ã“ã‚Œã§ãƒãƒƒãƒãƒª âœ¨", "ãƒãƒ©ãƒ³ã‚¹ã„ã„ã˜ã‚ƒã‚“ ğŸŒ¿", "å¿ƒåœ°ã„ã„ä¸€é£Ÿã ã­ â˜ï¸", "ã„ã„ã¨æ€ã† ğŸ¤", "ã“ã‚Œãã‚‰ã„ãŒä¸åº¦ã„ã„ ğŸš", "ä»Šæ—¥ã®é‡ã€ã´ã£ãŸã‚Š ğŸ¥¢"];
        const pool_excess = ["ã¡ã‚‡ã£ã¨å¤šã„ã‹ã‚‚ï¼Ÿã§ã‚‚æ°—ã«ã—ãªãã¦ã„ã„ã‚ˆ ğŸŒ¸", "å°‘ã—å¤šã‚ã ã‘ã©ã€å¤§ä¸ˆå¤«ã ã‚ˆ ğŸŠ", "ä»Šæ—¥ã¯ãƒªãƒƒãƒãªé£Ÿäº‹ã ã­ ğŸŒ¼", "ãŸã¾ã«ã¯å¤šã‚ã§ã‚‚ã„ã„ã˜ã‚ƒã‚“ â˜€ï¸", "æº€è¶³æ„Ÿã‚ã‚‹ã­ã€œæ˜æ—¥èª¿æ•´ã™ã‚Œã°ã„ã„ã‚ˆ ğŸµ", "ã‚«ãƒ­ãƒªãƒ¼é«˜ã‚ã ã‘ã©ã€ä»Šæ—¥ã¯ã“ã‚Œã§OK ğŸŒ™", "ãŠè…¹ã„ã£ã±ã„ã ã­ã€æ¬¡ã‹ã‚‰æ°—ã‚’ã¤ã‘ã‚Œã°ã„ã„ã‚ˆ ğŸ¥", "ä»Šæ—¥ã¯å°‘ã—ã‚†ã‚‹ã‚ã ã­ã€å¿ƒé…ã—ãªã„ã§ ğŸ§¸"];
        const pool_heal = [" ã¾ãŸèµ·ãã‚‰ã‚Œã¾ã—ãŸã­ã€ã™ã”ã„ã€œ", " ä»Šæ—¥ã‚‚ç„¡äº‹ã«ç›®è¦šã‚ãŸã€œ", " ä»Šã¯ã‚†ã£ãã‚Šã§ãã‚‹æ—¶é—´ã ã­ã€œ", " ä»Šæ—¥ã¯ã‚‚ã†ç»“æ„ã‚„ã£ãŸã­ã€œ", " ã¾ãŸæ— äº‹ã«ä¸€æ—¥è¿‡ã”ã›ãŸã­ã€ã™ã”ã„ã€‚"];

        const db = {
            morning: { staple: [ {e:"ğŸ—", n:"ãƒ•ã‚¡ãƒŸãƒã‚­", k:252, p:12.7, f:16.5, c:13.1}, {e:"ğŸ§‡", n:"ãƒ¯ãƒƒãƒ•ãƒ«", k:245, p:4.2, f:12.6, c:28.4}, {e:"ğŸ¥ª", n:"ãƒŸãƒƒã‚¯ã‚¹ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ", k:312, p:10.5, f:16.8, c:29.1}, {e:"ğŸŒ­", n:"ã‚¢ãƒ¡ãƒªã‚«ãƒ³ãƒ‰ãƒƒã‚°", k:285, p:7.2, f:14.2, c:31.5}, {e:"ğŸš", n:"ï¼´ï¼«ï¼§", k:310, p:9.1, f:6.2, c:53.5}, {e:"ğŸš", n:"ç´è±†ã”é£¯", k:355, p:12.8, f:6.1, c:61.2}, {e:"ğŸ™", n:"ãƒ„ãƒŠãƒãƒ¨ãŠã«ãã‚Š", k:390, p:8.4, f:14.2, c:63.5}, {e:"ğŸ", n:"ãƒ”ã‚¶ãƒˆãƒ¼ã‚¹ãƒˆ", k:295, p:10.8, f:11.5, c:36.2} ] },
            meal: {
                staple: [ {e:"ğŸœ", n:"æ²–ç¸„ãã°", k:520, p:20.5, f:15.2, c:72.4}, {e:"ğŸ", n:"ç„¼ããã°", k:485, p:13.2, f:18.5, c:65.4}, {e:"ğŸ›", n:"ã‹ãæšã’ã‚«ãƒ¬ãƒ¼", k:820, p:15.4, f:35.2, c:102.5}, {e:"ğŸ£", n:"å¯¿å¸ (10è²«)", k:520, p:22.4, f:3.5, c:92.4}, {e:"ğŸœ", n:"çš¿ã†ã©ã‚“", k:580, p:16.5, f:22.4, c:76.2}, {e:"ğŸ", n:"ã‚«ãƒ«ãƒœãƒŠãƒ¼ãƒ©", k:710, p:20.5, f:38.2, c:68.4}, {e:"ğŸ›", n:"ã‚ªãƒ ãƒ©ã‚¤ã‚¹", k:650, p:18.2, f:24.5, c:82.4}, {e:"ğŸš", n:"æ˜å¤ªå­ã”é£¯", k:365, p:9.5, f:2.8, c:73.4}, {e:"ğŸ•", n:"ãƒ”ã‚¶ (3ç‰‡)", k:680, p:26.5, f:30.2, c:75.4}, {e:"ğŸ¥¢", n:"ã–ã‚‹è•éº¦", k:380, p:14.2, f:2.1, c:78.4} ],
                main: [ {e:"ğŸ¥©", n:"ã¨ã‚“ã‹ã¤", k:420, p:20.5, f:32.4, c:11.2}, {e:"ğŸ²", n:"ã¡ã‚Šã¨ã‚Šé‹", k:380, p:28.5, f:22.4, c:9.5}, {e:"ğŸ¥©", n:"ç„¼ãè‚‰", k:440, p:18.4, f:38.2, c:5.2}, {e:"ğŸ¥˜", n:"ãƒ“ãƒ¼ãƒ•ã‚·ãƒãƒ¥ãƒ¼", k:410, p:16.5, f:28.4, c:22.5}, {e:"ğŸ¥”", n:"è‚‰ã˜ã‚ƒãŒ", k:290, p:10.2, f:12.4, c:28.5}, {e:"ğŸ³", n:"ã‚ªãƒ ãƒ¬ãƒ„", k:280, p:14.2, f:22.5, c:3.2}, {e:"ğŸ¥£", n:"è±šæ±", k:155, p:8.5, f:10.2, c:8.4}, {e:"ğŸ¥¬", n:"ç‰›è‚‰ã‚‚ã‚„ã—ç‚’ã‚", k:320, p:18.2, f:25.4, c:5.4}, {e:"ğŸ¥˜", n:"ã‚¯ãƒ©ãƒ ãƒãƒ£ã‚¦ãƒ€ãƒ¼", k:240, p:8.5, f:15.4, c:18.5}, {e:"ğŸ²", n:"æ²¹æšã’å‘³å™Œæ±", k:75, p:3.8, f:5.2, c:2.8}, {e:"ğŸ§…", n:"ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ãƒ¼ãƒ—", k:65, p:2.1, f:3.2, c:7.5}, {e:"ğŸµ", n:"ãŠå¸ã„ç‰©", k:12, p:0.8, f:0.1, c:1.8} ],
                side: [ {e:"ğŸ¢", n:"ä¸²ã‚«ãƒ„", k:240, p:10.5, f:16.2, c:12.4}, {e:"ğŸ¥”", n:"ã‚³ãƒ­ãƒƒã‚±", k:180, p:3.8, f:10.5, c:17.5}, {e:"ğŸ¥Ÿ", n:"é¤ƒå­ (6å€‹)", k:280, p:8.5, f:15.4, c:24.5}, {e:"ğŸ¤", n:"å¤©ã·ã‚‰ç››åˆã›", k:340, p:10.2, f:22.4, c:20.5}, {e:"ğŸŸ", n:"ãƒã‚°ãƒ­ã™ãèº«", k:140, p:21.5, f:5.2, c:0.5}, {e:"â¬œ", n:"å†·ã‚„ã£ã“", k:110, p:9.2, f:5.5, c:3.5}, {e:"ğŸ³", n:"ç‰å­ç„¼ã", k:145, p:9.5, f:10.2, c:3.5}, {e:"ğŸ¢", n:"ãŠã§ã‚“", k:165, p:12.4, f:3.8, c:16.5}, {e:"ğŸŸ", n:"ãªã‚ã‚ã†", k:135, p:15.5, f:7.2, c:1.5} ],
                drink: [ {e:"ğŸµ", n:"å®å®ã§ãŠèŒ¶", k:0, p:0, f:0, c:0}, {e:"ğŸ¥¤", n:"ã‚«ãƒ«ãƒ”ã‚¹", k:130, p:0.8, f:0, c:32.4}, {e:"ğŸ’§", n:"ãƒã‚«ãƒª", k:125, p:0, f:0, c:31.2}, {e:"ğŸ§ƒ", n:"é‡èœç”Ÿæ´»", k:65, p:0.8, f:0, c:15.5}, {e:"ğŸµ", n:"ã»ã†ã˜èŒ¶", k:0, p:0, f:0, c:0}, {e:"ğŸŒ¾", n:"éº¦èŒ¶", k:0, p:0, f:0, c:0}, {e:"ğŸŠ", n:"ã‚ªãƒ¬ãƒ³ã‚¸100", k:85, p:1.2, f:0, c:20.5}, {e:"ğŸ¥£", n:"ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ", k:75, p:3.8, f:2.8, c:9.5} ]
            }
        };

        function typeWriter(text, i, cb) {
            if (i < text.length) {
                document.getElementById("typewriter").innerHTML += text.charAt(i);
                setTimeout(() => typeWriter(text, i + 1, cb), 70);
            } else if (cb) cb();
        }

        function getUniq(queue, pool) {
            if (queue.length === 0) {
                let arr = [...pool].sort(() => Math.random() - 0.5);
                queue.push(...arr);
            }
            return queue.pop();
        }

        function getNextFood(type) {
            const list = db[mode][type];
            if (!queues.food[mode][type] || queues.food[mode][type].length === 0) {
                let arr = [...Array(list.length).keys()].sort(() => Math.random() - 0.5);
                queues.food[mode][type] = arr;
            }
            return list[queues.food[mode][type].pop()];
        }

        function showPop(el) {
            const pop = el.querySelector('.popover');
            pop.style.display = 'block';
            setTimeout(() => { pop.style.display = 'none'; }, 1500);
        }

        window.onload = () => {
            typeWriter("å®å®åƒé¥­å•¦ï¼Œè¦åƒä»€ä¹ˆå‘¢ï¼Ÿ", 0);
            document.getElementById('splash-emoji').innerText = getUniq(queues.splash, pool_splash);
        };

        function startApp() {
            playCrystalSound();
            document.getElementById('splash').style.opacity = '0';
            setTimeout(() => { document.getElementById('splash').style.display = 'none'; rollAll(); }, 500);
        }

        function toggleMode(m) {
            playCrystalSound();
            mode = m;
            document.getElementById('m-btn').classList.toggle('active', m==='morning');
            document.getElementById('l-btn').classList.toggle('active', m==='meal');
            rollAll();
        }

        function rollAllWithSound() {
            playCrystalSound();
            rollAll();
        }

        function rollAll() {
            const types = (mode === 'morning') ? ['staple'] : ['staple', 'main', 'side', 'drink'];
            types.forEach(t => selection[t] = getNextFood(t));
            updateUI();
        }

        function reRoll(t) {
            playCrystalSound();
            selection[t] = getNextFood(t);
            updateUI(t);
        }

        function updateUI(flashType = null) {
            const types = (mode === 'morning') ? ['staple'] : ['staple', 'main', 'side', 'drink'];
            const labels = {staple:'ä¸»é£Ÿ', main:'ä¸»èœ/æ±ç‰©', side:'å‰¯èœ/å°é£Ÿ', drink:'é£²ã¿ç‰©'};
            let html = "", tk=0, tp=0, tf=0, tc=0;
            
            types.forEach(t => {
                const item = selection[t];
                html += `
                <div class="row ${flashType === t ? 'fade-in' : ''}">
                    <div class="item-info">
                        <span class="item-emoji">${item.e}</span>
                        <div class="item-text">
                            <span class="tag">${labels[t]}</span>
                            <span class="name">${item.n}</span>
                        </div>
                    </div>
                    <span class="kcal-box">${Math.round(item.k)} <small>kcal</small></span>
                    <button class="refresh-btn" onclick="reRoll('${t}')">ğŸ”„</button>
                </div>`;
                tk+=item.k; tp+=item.p; tf+=item.f; tc+=item.c;
            });

            document.getElementById('list').innerHTML = html;
            document.getElementById('k').innerText = Math.round(tk);
            document.getElementById('p').innerText = tp.toFixed(1);
            document.getElementById('f').innerText = tf.toFixed(1);
            document.getElementById('c').innerText = tc.toFixed(1);

            const advBase = document.getElementById('adv-base');
            const advEmo = document.getElementById('adv-emo');
            let mainTxt = (tk > 950) ? getUniq(queues.excess, pool_excess) : getUniq(queues.normal, pool_normal);
            let healTxt = getUniq(queues.heal, pool_heal);
            advBase.innerHTML = (tk > 950) ? `<b style="color:var(--warn)">ã€åˆ†æã€‘</b> ãƒ‘ãƒ¯ãƒ•ãƒ«ï¼ ` : `<b style="color:var(--accent)">ã€åˆ†æã€‘</b> ãƒãƒ©ãƒ³ã‚¹ã„ã„ã­ï¼ `;
            advEmo.innerText = mainTxt + healTxt;
        }
    </script>
</body>
</html>

